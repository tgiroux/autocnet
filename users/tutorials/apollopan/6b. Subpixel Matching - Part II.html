<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8">
    
    <title>Subpixel Matching - Part II &mdash; AutoCNet</title>
    
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/css/spc-extend.css">
    <link rel="stylesheet" href="../../../_static/scipy.css" type="text/css" >
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" >
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     'Please install this project with setup.py',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../None"></script>
    <script type="text/javascript" src="../../../_static/js/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" >
    <link rel="search" title="Search" href="../../../search.html" >
    <link rel="top" title="AutoCNet" href="../../../index.html" >
    <link rel="up" title="Working With Apollo Pan" href="../index.html" >
    <link rel="next" title="Saving and Loading" href="7. Saving and Loading.html" >
    <link rel="prev" title="Subpixel Matching - Part I" href="6a. Subpixel Matching - Part I.html" > 
  </head>
  <body>

  <div class="container">
    <div class="header">
    </div>
  </div>


    <div class="container">
      <div class="main">
        
	<div class="row-fluid">
	  <div class="span12">
	    <div class="spc-navbar">
              
    <ul class="nav nav-pills pull-left">
	
        <li class="active"><a href="../../../index.html">AutoCNet</a></li>
	
          <li class="active"><a href="../../index.html" >&lt;no title&gt;</a></li>
          <li class="active"><a href="../index.html" accesskey="U">Working With Apollo Pan</a></li> 
    </ul>
              
              
    <ul class="nav nav-pills pull-right">
      <li class="active">
        <a href="../../../genindex.html" title="General Index"
           accesskey="I">index</a>
      </li>
      <li class="active">
        <a href="../../../py-modindex.html" title="Python Module Index"
           >modules</a>
      </li>
      <li class="active">
        <a href="7. Saving and Loading.html" title="Saving and Loading"
           accesskey="N">next</a>
      </li>
      <li class="active">
        <a href="6a. Subpixel Matching - Part I.html" title="Subpixel Matching - Part I"
           accesskey="P">previous</a>
      </li>
    </ul>
              
	    </div>
	  </div>
	</div>
        

	<div class="row-fluid">
      <div class="spc-rightsidebar span3">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Subpixel Matching - Part II</a><ul>
<li><a class="reference internal" href="#Create-the-CandidateGraph">Create the CandidateGraph</a></li>
<li><a class="reference internal" href="#Match-and-Find-Outliers">Match and Find Outliers</a></li>
<li><a class="reference internal" href="#Subpixel-Refinement">Subpixel Refinement</a><ul>
<li><a class="reference internal" href="#Subpixel-Parameters-:">Subpixel Parameters :</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Subpixel-Results">Subpixel Results</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="6a. Subpixel Matching - Part I.html"
                        title="previous chapter">Subpixel Matching - Part I</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="7. Saving and Loading.html"
                        title="next chapter">Saving and Loading</a></p>
  <h3>This Page</h3>
  <div>
    <a href="../../../_sources/users/tutorials/apollopan/6b. Subpixel Matching - Part II.ipynb.txt"
       rel="nofollow">Show Source</a>
  </div>
<div class="this-page-menu">
  <a href="/scipy/docs/scipy-docs/users/tutorials/apollopan/6b. Subpixel Matching - Part II.ipynb.rst">Edit page</a>
</div>

        </div>
      </div>
          <div class="span9">
            
        <div class="bodywrapper">
          <div class="body" id="spc-section-body">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Subpixel-Matching---Part-II">
<h1>Subpixel Matching - Part II<a class="headerlink" href="#Subpixel-Matching---Part-II" title="Permalink to this headline">¶</a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;/data/autocnet&#39;</span><span class="p">))</span>

<span class="kn">import</span> <span class="nn">autocnet</span>
<span class="c1"># Enable the GPU</span>
<span class="n">autocnet</span><span class="o">.</span><span class="n">cuda</span><span class="p">(</span><span class="n">enable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">autocnet</span> <span class="kn">import</span> <span class="n">CandidateGraph</span>

<span class="c1"># The GPU based extraction library that contains SIFT extraction and matching</span>
<span class="kn">import</span> <span class="nn">cudasift</span> <span class="k">as</span> <span class="nn">cs</span>
<span class="c1"># A method to resize the images on the fly.</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imresize</span>

<span class="o">%</span><span class="k">pylab</span> inline
<span class="n">figsize</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="section" id="Create-the-CandidateGraph">
<h2>Create the CandidateGraph<a class="headerlink" href="#Create-the-CandidateGraph" title="Permalink to this headline">¶</a></h2>
<p>Just like the other notebooks this cell creates the candidate graph. This also patches in functionality to the object on the fly. To get a handle on what is going on, checkout the <a class="reference internal" href="Advanced 1. Extending the CandidateGraph.html"><span class="doc">Advanced 1. Extending the CandidateGraph</span></a> notebook.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Create the candidate graph and enable a GPU</span>
<span class="n">a</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0111_CENTER_LRG_CROPPED.png&#39;</span>
<span class="n">b</span> <span class="o">=</span> <span class="s1">&#39;AS15-P-0112_CENTER_LRG_CROPPED.png&#39;</span>

<span class="n">adj</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:[</span><span class="n">b</span><span class="p">],</span>
       <span class="n">b</span><span class="p">:[</span><span class="n">a</span><span class="p">]}</span>

<span class="n">cg</span> <span class="o">=</span> <span class="n">CandidateGraph</span><span class="o">.</span><span class="n">from_adjacency</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>

<span class="c1"># Define a function to do the feature extraction.</span>
<span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">downsample_amount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">total_size</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">downsample_amount</span><span class="p">:</span>
        <span class="n">downsample_amount</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_size</span> <span class="o">/</span> <span class="mi">12500</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">downsample_amount</span><span class="p">))</span>
    <span class="c1"># Downsample</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">imresize</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;lanczos&#39;</span><span class="p">)</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.5</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">PySiftData</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    <span class="n">cs</span><span class="o">.</span><span class="n">ExtractKeypoints</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">kp</span><span class="p">,</span> <span class="n">des</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="n">to_data_frame</span><span class="p">()</span>
    <span class="n">kp</span> <span class="o">=</span> <span class="n">kp</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="s1">&#39;sharpness&#39;</span><span class="p">,</span> <span class="s1">&#39;edgeness&#39;</span><span class="p">,</span> <span class="s1">&#39;orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;ambiguity&#39;</span><span class="p">]]</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">kp</span><span class="p">[</span><span class="s1">&#39;ambiguity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Match the interface defined in the edge.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keypoints</span> <span class="o">=</span> <span class="n">kp</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">descriptors</span> <span class="o">=</span> <span class="n">des</span>

    <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">downsample_amount</span>

<span class="c1"># Import the class and update it.  This updates the current instance of the CandidateGraph</span>
<span class="kn">from</span> <span class="nn">autocnet.graph.node</span> <span class="kn">import</span> <span class="n">Node</span>
<span class="n">Node</span><span class="o">.</span><span class="n">extract_features</span> <span class="o">=</span> <span class="n">extract_features</span>

<span class="c1"># Extract the features</span>
<span class="n">cg</span><span class="o">.</span><span class="n">extract_features</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Match-and-Find-Outliers">
<h2>Match and Find Outliers<a class="headerlink" href="#Match-and-Find-Outliers" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Match</span>
<span class="n">cg</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>

<span class="c1"># Apply outlier detection - see the above linked notebook if you are curious about what is going on here.</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">edges_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">ambiguity</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">ambiguity</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="o">.</span><span class="n">matches</span><span class="o">.</span><span class="n">score</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.85</span><span class="p">)</span>

<span class="c1"># Compute the F Matrix</span>
<span class="n">cg</span><span class="o">.</span><span class="n">compute_fundamental_matrices</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Subpixel-Refinement">
<h2>Subpixel Refinement<a class="headerlink" href="#Subpixel-Refinement" title="Permalink to this headline">¶</a></h2>
<p>The last notebook looked at the results of subpixel refinement to explore the result quality. In this notebook, subpixel refinement is simply applied using the built-in syntax sugar.</p>
<p><strong>Caveat</strong>: AutoCNet does not (yet?) natively support up and down sampling so the user has to manually rescale the correspondences. The dev. team is thinking about if, and how best to implement multi-resolution tracking without adding lots of complexity.</p>
<div class="section" id="Subpixel-Parameters-:">
<h3>Subpixel Parameters :<a class="headerlink" href="#Subpixel-Parameters-:" title="Permalink to this headline">¶</a></h3>
<p>Since the Apollo Pan data was originally processed at a reduced resolution, the <code class="docutils literal notranslate"><span class="pre">max_x_shift</span></code> and <code class="docutils literal notranslate"><span class="pre">max_y_shift</span></code> parameters are allowed to be larger than the normal 1-pixel constraint. Aslo, <code class="docutils literal notranslate"><span class="pre">clean_keys</span></code> are passed to subpixel register only the best matches currently found and <code class="docutils literal notranslate"><span class="pre">tiled</span></code> is set to true indicating that the entire image is <strong>not</strong> to be read into memory.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="c1"># Scale the keypoints coordinates back to full resolution.</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n</span><span class="o">.</span><span class="n">keypoints</span><span class="o">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span>
    <span class="n">n</span><span class="o">.</span><span class="n">keypoints</span><span class="o">.</span><span class="n">y</span> <span class="o">*=</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span>

<span class="n">cg</span><span class="o">.</span><span class="n">subpixel_register</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fundamental&#39;</span><span class="p">],</span> <span class="n">tiled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">,</span> <span class="n">max_x_shift</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_y_shift</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="c1"># Scale the keypoint coordinates back to the reduced resolution</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cg</span><span class="o">.</span><span class="n">nodes_iter</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">n</span><span class="o">.</span><span class="n">keypoints</span><span class="o">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span>
    <span class="n">n</span><span class="o">.</span><span class="n">keypoints</span><span class="o">.</span><span class="n">y</span> <span class="o">/=</span> <span class="n">n</span><span class="p">[</span><span class="s1">&#39;downsample_amount&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Subpixel-Results">
<h2>Subpixel Results<a class="headerlink" href="#Subpixel-Results" title="Permalink to this headline">¶</a></h2>
<p>The subpixel matcher updates the masks with three new entries for (1) <code class="docutils literal notranslate"><span class="pre">shift</span></code>: has the correspondenced moved too far, (2) <code class="docutils literal notranslate"><span class="pre">threshold</span></code>: is the correlation good enough, and <code class="docutils literal notranslate"><span class="pre">subpixel</span></code>: the combination of (1) and (2).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ratio</th>
      <th>score</th>
      <th>fundamental</th>
      <th>shift</th>
      <th>threshold</th>
      <th>subpixel</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Use the `clean` method to get back the subpixel registered correspondences.</span>
<span class="n">matches</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clean</span><span class="p">([</span><span class="s1">&#39;subpixel&#39;</span><span class="p">])</span>
<span class="n">matches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source_image</th>
      <th>source_idx</th>
      <th>destination_image</th>
      <th>destination_idx</th>
      <th>score</th>
      <th>ambiguity</th>
      <th>y_offset</th>
      <th>x_offset</th>
      <th>reference</th>
      <th>correlation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>17</td>
      <td>1.0</td>
      <td>296</td>
      <td>0.985350</td>
      <td>0.861263</td>
      <td>0.1250</td>
      <td>6.3750</td>
      <td>0.0</td>
      <td>0.999713</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.0</td>
      <td>21</td>
      <td>1.0</td>
      <td>291</td>
      <td>0.979893</td>
      <td>0.816333</td>
      <td>-1.2500</td>
      <td>4.8750</td>
      <td>0.0</td>
      <td>0.999727</td>
    </tr>
    <tr>
      <th>283</th>
      <td>0.0</td>
      <td>283</td>
      <td>1.0</td>
      <td>1173</td>
      <td>0.978444</td>
      <td>0.890681</td>
      <td>3.0000</td>
      <td>5.1875</td>
      <td>0.0</td>
      <td>0.999637</td>
    </tr>
    <tr>
      <th>291</th>
      <td>0.0</td>
      <td>291</td>
      <td>1.0</td>
      <td>1230</td>
      <td>0.958613</td>
      <td>0.936126</td>
      <td>3.0000</td>
      <td>-2.0000</td>
      <td>0.0</td>
      <td>0.999747</td>
    </tr>
    <tr>
      <th>309</th>
      <td>0.0</td>
      <td>309</td>
      <td>1.0</td>
      <td>1175</td>
      <td>0.977205</td>
      <td>0.930651</td>
      <td>-3.1875</td>
      <td>2.3125</td>
      <td>0.0</td>
      <td>0.999675</td>
    </tr>
    <tr>
      <th>338</th>
      <td>0.0</td>
      <td>338</td>
      <td>1.0</td>
      <td>1295</td>
      <td>0.971325</td>
      <td>0.911120</td>
      <td>-3.5625</td>
      <td>6.7500</td>
      <td>0.0</td>
      <td>0.999822</td>
    </tr>
    <tr>
      <th>345</th>
      <td>0.0</td>
      <td>345</td>
      <td>1.0</td>
      <td>1290</td>
      <td>0.971112</td>
      <td>0.907802</td>
      <td>-6.6875</td>
      <td>-2.3125</td>
      <td>0.0</td>
      <td>0.999785</td>
    </tr>
    <tr>
      <th>353</th>
      <td>0.0</td>
      <td>353</td>
      <td>1.0</td>
      <td>1261</td>
      <td>0.984677</td>
      <td>0.789020</td>
      <td>-6.0625</td>
      <td>5.4375</td>
      <td>0.0</td>
      <td>0.999745</td>
    </tr>
    <tr>
      <th>356</th>
      <td>0.0</td>
      <td>356</td>
      <td>1.0</td>
      <td>1262</td>
      <td>0.979318</td>
      <td>0.899721</td>
      <td>4.8125</td>
      <td>-4.7500</td>
      <td>0.0</td>
      <td>0.999745</td>
    </tr>
    <tr>
      <th>366</th>
      <td>0.0</td>
      <td>366</td>
      <td>1.0</td>
      <td>1272</td>
      <td>0.985263</td>
      <td>0.876244</td>
      <td>-5.4375</td>
      <td>-1.1250</td>
      <td>0.0</td>
      <td>0.999751</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Use the `clean` method to get back the subpixel registered correspondences.</span>
<span class="n">matches</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clean</span><span class="p">([</span><span class="s1">&#39;threshold&#39;</span><span class="p">])</span>
<span class="n">matches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>source_image</th>
      <th>source_idx</th>
      <th>destination_image</th>
      <th>destination_idx</th>
      <th>score</th>
      <th>ambiguity</th>
      <th>y_offset</th>
      <th>x_offset</th>
      <th>reference</th>
      <th>correlation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>17</th>
      <td>0.0</td>
      <td>17</td>
      <td>1.0</td>
      <td>296</td>
      <td>0.985350</td>
      <td>0.861263</td>
      <td>0.1250</td>
      <td>6.3750</td>
      <td>0.0</td>
      <td>0.999713</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0.0</td>
      <td>21</td>
      <td>1.0</td>
      <td>291</td>
      <td>0.979893</td>
      <td>0.816333</td>
      <td>-1.2500</td>
      <td>4.8750</td>
      <td>0.0</td>
      <td>0.999727</td>
    </tr>
    <tr>
      <th>283</th>
      <td>0.0</td>
      <td>283</td>
      <td>1.0</td>
      <td>1173</td>
      <td>0.978444</td>
      <td>0.890681</td>
      <td>3.0000</td>
      <td>5.1875</td>
      <td>0.0</td>
      <td>0.999637</td>
    </tr>
    <tr>
      <th>291</th>
      <td>0.0</td>
      <td>291</td>
      <td>1.0</td>
      <td>1230</td>
      <td>0.958613</td>
      <td>0.936126</td>
      <td>3.0000</td>
      <td>-2.0000</td>
      <td>0.0</td>
      <td>0.999747</td>
    </tr>
    <tr>
      <th>293</th>
      <td>0.0</td>
      <td>293</td>
      <td>1.0</td>
      <td>1235</td>
      <td>0.985849</td>
      <td>0.871732</td>
      <td>-9.0000</td>
      <td>-2.0000</td>
      <td>0.0</td>
      <td>0.999773</td>
    </tr>
    <tr>
      <th>296</th>
      <td>0.0</td>
      <td>296</td>
      <td>1.0</td>
      <td>1239</td>
      <td>0.967968</td>
      <td>0.927719</td>
      <td>-7.6250</td>
      <td>-4.5000</td>
      <td>0.0</td>
      <td>0.999759</td>
    </tr>
    <tr>
      <th>298</th>
      <td>0.0</td>
      <td>298</td>
      <td>1.0</td>
      <td>1238</td>
      <td>0.964188</td>
      <td>0.898417</td>
      <td>-10.6875</td>
      <td>13.1250</td>
      <td>0.0</td>
      <td>0.999724</td>
    </tr>
    <tr>
      <th>309</th>
      <td>0.0</td>
      <td>309</td>
      <td>1.0</td>
      <td>1175</td>
      <td>0.977205</td>
      <td>0.930651</td>
      <td>-3.1875</td>
      <td>2.3125</td>
      <td>0.0</td>
      <td>0.999675</td>
    </tr>
    <tr>
      <th>338</th>
      <td>0.0</td>
      <td>338</td>
      <td>1.0</td>
      <td>1295</td>
      <td>0.971325</td>
      <td>0.911120</td>
      <td>-3.5625</td>
      <td>6.7500</td>
      <td>0.0</td>
      <td>0.999822</td>
    </tr>
    <tr>
      <th>345</th>
      <td>0.0</td>
      <td>345</td>
      <td>1.0</td>
      <td>1290</td>
      <td>0.971112</td>
      <td>0.907802</td>
      <td>-6.6875</td>
      <td>-2.3125</td>
      <td>0.0</td>
      <td>0.999785</td>
    </tr>
    <tr>
      <th>353</th>
      <td>0.0</td>
      <td>353</td>
      <td>1.0</td>
      <td>1261</td>
      <td>0.984677</td>
      <td>0.789020</td>
      <td>-6.0625</td>
      <td>5.4375</td>
      <td>0.0</td>
      <td>0.999745</td>
    </tr>
    <tr>
      <th>355</th>
      <td>0.0</td>
      <td>355</td>
      <td>1.0</td>
      <td>1267</td>
      <td>0.965001</td>
      <td>0.915773</td>
      <td>-14.0000</td>
      <td>15.3750</td>
      <td>0.0</td>
      <td>0.999711</td>
    </tr>
    <tr>
      <th>356</th>
      <td>0.0</td>
      <td>356</td>
      <td>1.0</td>
      <td>1262</td>
      <td>0.979318</td>
      <td>0.899721</td>
      <td>4.8125</td>
      <td>-4.7500</td>
      <td>0.0</td>
      <td>0.999745</td>
    </tr>
    <tr>
      <th>366</th>
      <td>0.0</td>
      <td>366</td>
      <td>1.0</td>
      <td>1272</td>
      <td>0.985263</td>
      <td>0.876244</td>
      <td>-5.4375</td>
      <td>-1.1250</td>
      <td>0.0</td>
      <td>0.999751</td>
    </tr>
    <tr>
      <th>386</th>
      <td>0.0</td>
      <td>386</td>
      <td>1.0</td>
      <td>1248</td>
      <td>0.984362</td>
      <td>0.885029</td>
      <td>15.8750</td>
      <td>17.0000</td>
      <td>0.0</td>
      <td>0.999772</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cg</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">clean_keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span> <span class="n">downsampling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f4674d24a58&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../_images/users_tutorials_apollopan_6b._Subpixel_Matching_-_Part_II_12_1.png" src="../../../_images/users_tutorials_apollopan_6b._Subpixel_Matching_-_Part_II_12_1.png" />
</div>
</div>
</div>
</div>


          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container container-navbar-bottom">
      <div class="spc-navbar">
        
      </div>
    </div>
    <div class="container">
    <div class="footer">
    <div class="row-fluid">
    <ul class="inline pull-left">
      <li>
        &copy; Copyright 2017 - , AutoCNetDevelopers.
      </li>
      <li>
      Last updated on Jul 27, 2020.
      </li>
      <li>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 3.1.2.
      </li>
    </ul>
    </div>
    </div>
    </div>
  </body>
</html>